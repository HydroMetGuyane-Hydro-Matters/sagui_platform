## Architecture logicielle

Sur le plan logiciel, la plate-forme se compose des éléments suivants : 
- frontend javascript. Définit l'interface utilisateur. Consomme les services fournis par l'API et les services carto (Vector Tiles)
- backend constitué de 
  - API de données codé en python (framework django)
  - seveur de MVT (vector tiles)
  - base de données PostGIS

### Base de données PostGIS
La base de données PostGIS stocke l'intégralité des données de l'application. 
C'est aussi elle qui fournit une grosse partie de la logique de l'application. En effet, une base de donnée n'est pas qu'un outil de stockage. On peut aussi y définir des vues et fonctions. Bien utilisée, elle permet d'effectuer un grand nombre de transformations et traitements, au plus près de la donnée.

#### Tables de données
En dehors des tables gérées de façon standard par Django, la base contient les tables suivantes : 

| table                    | définition                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| sagui_importstate        | Stocke notamment la date de dernière mise à jour des données. Utilisée pour optimiser les imports et mises à jour des données. Potentiellement utile aussi pour des tâches de monitoring (pas encore en place)                                                                                                                                                                     |
| sagui_saguiconfig        | éléments configurables de façon dynamique. Pour l'instant, seulement : *max_ordem* : filtre les données de drainage, ne retient que >= max_ordem. *use_dataset* : assimilated ou mgbstandard. Les données exposées par l'API seront basées sur le jeud de données choisi ici (défaut : assimilated). Cette table est éditable depuis l'interface admin django                      |
| hyfaa_stations           | Liste des stations + définition des seuils de débits. Cette table est importée depuis un fichier excel, mais est aussi éditable depuis l'interface admin django                                                                                                                                                                                                                    |
| hyfaa_geo_inclusion_mask | Permet de définir des polygones géographiques limitant la surface affichée, pour les drainages. Si plusieurs polygones sont définis, ils sont aggrégés. Seules les entités de drainage incluses dans cet espace seront affichées. Cette table est vide par défaut (on affiche tout), et peut être éditée via l'interface d'admin de django                                         |
| hyfaa_drainage           | réseau de drainage mgb. Cette table est importée. Les données sources sont issues du shapefile drainage croisé avec le shapefile minibasins, via le script [publish.sh](https://raw.githubusercontent.com/HydroMetGuyane-Hydro-Matters/sagui_backend/main/data/publish.sh)                                                                                                         |
| hyfaa_catchments         | minibassins mgb. Cette table est importée. Les données sources sont issues du shapefile catchments croisé avec le shapefile minibasins, via le script [publish.sh](https://raw.githubusercontent.com/HydroMetGuyane-Hydro-Matters/sagui_backend/main/data/publish.sh). Le shapefile catchments est lui-même généré à partir du fichier grid, et soumis à divers traitement en chemin |
| hyfaa_minibasins_data    | données attributaires des minibassins/drainage. Cette table est importée du shapefile minibasins, sans retenir l'élément géographique (point), via le script [publish.sh](https://raw.githubusercontent.com/HydroMetGuyane-Hydro-Matters/sagui_backend/main/data/publish.sh).                                                                                                      |
| hyfaa_data_assimilated   | Contient les données hyfaa assimilated. Un enregistrement par couple (cell_id, date). Les champs flow_expected et flow_anomaly sont calculés à chaque nouvelle insertion via le trigger publication_post_processing                                                                                                                                                                |
| hyfaa_data_mgbstandard   | Contient les données hyfaa mgbstandard. Un enregistrement par couple (cell_id, date). Les champs flow_expected et flow_anomaly sont calculés à chaque nouvelle insertion via le trigger publication_post_processing                                                                                                                                                      |
| hyfaa_data_forecast      | Contient les données hyfaa forecast. Un enregistrement par couple (cell_id, date). Les champs flow_expected et flow_anomaly sont calculés à chaque nouvelle insertion via le trigger publication_post_processing                                                                                                                                                         |

#### Vues et vues matérialisées

A partir de ces données sont générées les vues listées dans le tableau suivant. Les vues simples sont juste des requêtes stockées en mémoire, simplifiant leur accès, mais nécessitant tout de même de rejouer la requête à chaque fois. Les vues matérialisées sont un hybride entre table et vue : elles sont définies comme des vues (calculés à partir d'une requête sur des tables/vues existantes) mais stockées en BD, donc à accès rapide et optimisé. Pour les actualiser, il faut lancer explicitement une commande REFRESH. C'est ce que fait le trigger publication_post_processing qui lance un REFRESH à chaque mise à jour de la table sagui_importstate


| table                                         | type   | définition                                                                                                                                                                                                                                                                                                                                  |
|-----------------------------------------------|--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **[Drainage]**                                |        |                                                                                                                                                                                                                                                                                                                                             |
| hyfaa_drainage_with_attributes                | vue    | jointe le drainage avec des données issues de hyfaa_minibasins_data                                                                                                                                                                                                                                                                         |
| drainage_mgb_masked                           | vue    | filtre les données geo drainage en fonction du hyfaa_geo_inclusion_mask                                                                                                                                                                                                                                                                     |
| hyfaa_data_assimilated_aggregate_json         | vue    | données assimilées filtrées et aggrégées : pour chaque cell_id, définit un objet json contenant flow et flow_anomaly pour les 15 derniers jours                                                                                                                                                                                             |
| hyfaa_data_mgbstandard_aggregate_json         | vue    | idem                                                                                                                                                                                                                                                                                                                                        |
| hyfaa_data_with_assimilated_aggregate_geo     | vue matérialisée | Combine la vue précédente avec la couche géo drainage_mgb_masked. Dispo pour affichage via Vector tiles                                                                                                                                                                                                                                     |
| hyfaa_data_with_mgbstandard_aggregate_geo     | vue matérialisée | Combine la vue précédente avec la couche géo drainage_mgb_masked. Dispo pour affichage via Vector tiles                                                                                                                                                                                                                                     |  
| hyfaa_data__aggregated_geo                    | vue    | Sélectionne l'une ou l'autre des deux vues geo ci-dessus, en fonction de l'attribut use_dataset de la table sagui_saguiconfig. Permet de basculer facilement de l'une à l'autre simplement via l'interface admin de django. Repose sur la fonction func_hyfaa_data_aggregated_geo qui permet d'assurer ce changement de façon dynamique     |
| hyfaa_forecast_with_assimilated               | vue matérialisée | Combine les données forecast et les données assimilated des 10 derniers jours                                                                                                                                                                                                                                                               |
| hyfaa_forecast_with_mgbstandard               | vue matérialisée | Combine les données forecast et les données mgbstandard des 10 derniers jours                                                                                                                                                                                                                                                               |
| hyfaa_forecast_with_assimilated_aggregate_geo | vue matérialisée | Aggrège les données de la table ci-dessus en un objet json  (flow, flow_anomaly) et jointe avec la donnée geo drainage_mgb_masked. Dispo pour diffusion via Vector Tiles                                                                                                                                                                    |
| hyfaa_forecast_with_mgbstandard_aggregate_geo | vue matérialisée | idem                                                                                                                                                                                                                                                                                                                                        |
| hyfaa_forecast__aggregated_geo                | vue    | Sélectionne l'une ou l'autre des deux vues geo ci-dessus, en fonction de l'attribut use_dataset de la table sagui_saguiconfig. Permet de basculer facilement de l'une à l'autre simplement via l'interface admin de django. Repose sur la fonction func_hyfaa_forecast_aggregated_geo qui permet d'assurer ce changement de façon dynamique |
| **[Rainfall / Catchments]**                   |        |                                                                                                                                                                                                                                                                                                                                             |
| hyfaa_catchments_subbasins                    | vue    | Aggrège les entités geo catchment par attribut sub (sous-bassin)                                                                                                                                                                                                                                                                            |
| rainfall_minibasin_aggregated_geo             | vue matérialisée | aggrège les données de pluie des 15 derniers jours et les jointe avec la donnée géo catchments. Dispo pour diffusion via Vector Tiles                                                                                                                                                                                                       |
| rainfall_minibasin_aggregated_geo             | vue matérialisée | aggrège les données de pluie des 15 derniers jours et les jointe avec la donnée géo catchments. Dispo pour diffusion via Vector Tiles                                                                                                                                                                                                       |
| rainfall_subbasin_aggregated_geo              | vue matérialisée | aggrège les données de pluie des 15 derniers jours et les jointe avec la donnée géo hyfaa_catchments_subbasins. Dispo pour diffusion via Vector Tiles. La fonction mvt_rainfall permet un service de vector tiles basculant entre l'une et l'autre de ces deux vues selon le niveau de zoom                                                 |
| **[Stations]**                                |        |                                                                                                                                                                                                                                                                                                                                             |
| stations_with_flow_alerts                     | vue  | Stations (donnée géo) aggrégée avec l'information de niveau d'alerte de débit sur les 15 derniers jours, aggrégée en objet json                                                                                                                                                                                                             |
| stations_with_flow_previ                      | vue  | Stations (donnée géo) aggrégée avec l'information de niveau de prévi de débit sur les 15 derniers jours, aggrégée en objet json                                                                                                                                                                                                             |

#### Fonctions
Outre les fonctions définies nativement par PostGIS et PostgreSQL, plusieurs fonctions sont définie pour ce projet : 


| table                              | type                                                                                                                                                                               | définition                                                                                                                                                                                     |
|------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| func_hyfaa_data_aggregated_geo     | fonction                                                                                                                                                                           | pointe soit vers la vue mat. hyfaa_data_with_assimilated_aggregate_geo soit vers hyfaa_data_with_mgbstandard_aggregate_geo selon la valeur use_dataset dans la table sagui_saguiconfig         |
| func_hyfaa_forecast_aggregated_geo | fonction                                                                                                                                                                           | pointe soit vers la vue mat. hyfaa_forecast_with_assimilated_aggregate_geo soit vers hyfaa_forecast_with_mgbstandard_aggregate_geo selon la valeur use_dataset dans la table sagui_saguiconfig |
| func_stations_with_flow_alerts | fonction                                                                                                                                                                           | calcule les niveaux d'alerte de débit pour les stations. Utilisée pour définir la vue      stations_with_flow_alerts                                                                           |
| func_stations_with_flow_previ | fonction                                                                                                                                                                           | idem pour les prévi                                                                                                                                                                            |
| get_assimilated_values_for_minibasin | fonction                                                                                                                                                                           | *[deprecated]* aggrège les données assimilated sur une période donnée                                                                                                                          |
| get_forecast_values_for_minibasin | fonction                                                                                                                                                                           | *[deprecated]* aggrège les données assimilated sur une période donnée                                                                                                                          |
| get_mgbstandard_values_for_minibasin | fonction                                                                                                                                                                           | *[deprecated]* aggrège les données assimilated sur une période donnée                                                                                                                          |
| median | Fonction d'aggregation                                                                                                                                                             | Calcul de la médiane sur un ensemble de valeurs. S'utilise comme la moyenne (avg)                                                                                                              |
| publication_post_processing | fonction trigger                                                                                                                                                                   | déclenche le calcul des valeurs expected et anomaly manquantes et le rafraichissement des vues matérialisées                                                                                   |
| surrounding_days_of_year | fonction                                                                                                                                                                           | utilisée pour le calcul de la médiane flottante (+/- 10j autour du jour considéré, mais sur les années précédentes)                                                                            |
| surrounding_days_over_previous_years | fonction                                                                                                                                                                           | utilisée pour le calcul de la médiane flottante (+/- 10j autour du jour considéré, mais sur les années précédentes)                                                                            |
| update_forecast | fonction | calcul des valeurs expected et anomaly manquantes pour la table forecast et nettoyage des valeurs périmées. Utilisée par la fonction trigger  publication_post_processing                      |
